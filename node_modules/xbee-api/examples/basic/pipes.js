var SerialPort = require('serialport').SerialPort;
var xbee_api = require('../../lib/xbee-api.js');
var C = xbee_api.constants;

// Create ab xbee API object
var xbee = new xbee_api.XBeeAPI({
  api_mode: 1
});

// Use the stream wrapper
var xbeeStream = new xbee_api.XBeeStream(xbee);

// Open the serialport (>=v5.0.0)
var port = new SerialPort("COM5", {
  baudrate: 57600
});

// Pipe xbee packets to port
xbeeStream.pipe(port);

// Pipe serial data to xbee
port.pipe(xbeeStream);

// TODO...
port.on("open", function() {
  console.log("Serial port open... sending ATND");
  var frame = {
    type: C.FRAME_TYPE.AT_COMMAND,
    command: "ND",
    commandParameter: [],
  };

  serialport.write(xbeeAPI.buildFrame(frame), function(err, res) {
    if (err) throw(err);
    else     console.log("written bytes: "+util.inspect(res));
  });
});
